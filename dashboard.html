<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      transition: background 0.4s, color 0.4s;
      margin: 0;
      padding: 0;
    }

    body.dark {
      background-color: #111;
      color: white;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 200px;
      background: #202020;
      padding: 20px;
      color: white;
    }

    .sidebar button {
      display: block;
      background: none;
      border: none;
      color: inherit;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .sidebar button:hover {
      text-decoration: underline;
    }

    .content {
      flex: 1;
      padding: 20px;
      transition: opacity 0.3s ease-in-out;
    }

    .hidden {
      display: none;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #888;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active {
      background: #4ade80;
    }

    .toggle-switch.active::after {
      transform: translateX(26px);
    }

    input, button {
      margin: 8px 0;
      padding: 8px;
      font-size: 14px;
    }

    .btn {
      background: #444;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #666;
    }

    img {
      max-width: 100px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <button onclick="switchTab('account')">Account</button>
      <button onclick="switchTab('edit')">Edit Profile</button>
      <button onclick="switchTab('settings')">Settings</button>
    </div>
    <div class="content">
      <div id="account" class="tab">
        <h2>Account</h2>
        <p id="user-email">Loading...</p>
        <img id="user-avatar" />
      </div>

      <div id="edit" class="tab hidden">
        <h2>Edit Profile</h2>
        <input type="text" id="usernameInput" placeholder="New username" />
        <input type="text" id="avatarUrlInput" placeholder="New profile picture URL" />
        <button class="btn" onclick="updateProfile()">Save Changes</button>
        <button class="btn" onclick="useDiscordAvatar()">Use Discord Profile Picture (if linked)</button>
      </div>

      <div id="settings" class="tab hidden">
        <h2>Settings</h2>
        <p>Theme</p>
        <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
        <br />
        <button class="btn" onclick="linkDiscord()">Link Discord</button>
        <p id="discord-status"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const client = createClient("https://smcteblolwhfxcpngmvd.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtY3RlYmxvbHdoZnhjcG5nbXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0Nzk1MTUsImV4cCI6MjA3MDA1NTUxNX0.PWlZFiVv2E0Jah7tYGOGrbqkPwhxPoLhe0anINp0z3s");

    const user = await client.auth.getUser().then(res => res.data.user);

    if (!user) {
      location.href = "/";
    }

    const { data: profile } = await client
      .from("users")
      .select("*")
      .eq("id", user.id)
      .single();

    document.getElementById("user-email").textContent = user.email;
    document.getElementById("user-avatar").src = profile.avatar_url || "";

    const usernameInput = document.getElementById("usernameInput");
    const avatarUrlInput = document.getElementById("avatarUrlInput");

    usernameInput.value = profile.username || "";
    avatarUrlInput.value = profile.avatar_url || "";

    function switchTab(tab) {
      document.querySelectorAll(".tab").forEach(t => t.classList.add("hidden"));
      document.getElementById(tab).classList.remove("hidden");
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      document.getElementById("themeToggle").classList.toggle("active");
    }

    async function updateProfile() {
      const newUsername = usernameInput.value;
      const newAvatar = avatarUrlInput.value;

      const { error } = await client
        .from("users")
        .update({
          username: newUsername,
          avatar_url: newAvatar,
        })
        .eq("id", user.id);

      if (error) {
        alert("Error updating profile.");
      } else {
        alert("Profile updated!");
        document.getElementById("user-avatar").src = newAvatar;
      }
    }

    function linkDiscord() {
      const redirectTo = location.origin + "/dashboard.html";
      client.auth.signInWithOAuth({
        provider: "discord",
        options: { redirectTo }
      });
    }

    async function useDiscordAvatar() {
      const session = await client.auth.getSession().then(res => res.data.session);
      const provider = session?.user?.identities?.find(id => id.provider === "discord");
      if (!provider) {
        alert("Discord not linked.");
        return;
      }

      // Get avatar from identity data
      const avatar_url = `https://cdn.discordapp.com/avatars/${provider.id}/${provider.identity_data.avatar}.png`;
      avatarUrlInput.value = avatar_url;
      document.getElementById("user-avatar").src = avatar_url;

      await client
        .from("users")
        .update({ avatar_url })
        .eq("id", user.id);
    }

    // Check if Discord is linked
    const session = await client.auth.getSession().then(res => res.data.session);
    const discordLinked = session?.user?.identities?.some(id => id.provider === "discord");
    document.getElementById("discord-status").textContent = discordLinked ? "Discord Linked" : "Not Linked";
  </script>
</body>
</html>
