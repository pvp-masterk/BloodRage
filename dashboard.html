<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Bloodrage</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    };
  </script>
  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="dark bg-black text-white transition-all duration-300">

  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-60 bg-zinc-900 p-5 space-y-3">
      <h2 class="text-xl font-bold mb-4">Dashboard</h2>
      <button class="tab-button w-full text-left bg-zinc-800 p-2 rounded" data-tab="account">Account</button>
      <button class="tab-button w-full text-left bg-zinc-800 p-2 rounded" data-tab="edit-profile">Edit Profile</button>
      <button class="tab-button w-full text-left bg-zinc-800 p-2 rounded" data-tab="settings">Settings</button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-6 space-y-4 overflow-auto">
      <!-- Account -->
      <div id="account" class="tab-content fade-in">
        <h1 class="text-2xl font-bold mb-2">Account</h1>
        <p id="email">Loading...</p>
        <p id="username">Loading...</p>
        <img id="avatar" class="w-20 h-20 rounded-full mt-4" />
      </div>

      <!-- Edit Profile -->
      <div id="edit-profile" class="tab-content hidden fade-in">
        <h1 class="text-2xl font-bold mb-2">Edit Profile</h1>
        <input id="new-username" class="bg-zinc-800 p-2 rounded w-full mb-2" placeholder="New Username" />
        <button onclick="changeUsername()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Change Username</button>
        <br /><br />
        <input id="new-avatar" class="bg-zinc-800 p-2 rounded w-full mb-2" placeholder="New Avatar URL" />
        <button onclick="changeAvatar()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Change Avatar</button>
        <br /><br />
        <button onclick="useDiscordAvatar()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded">Use Discord Profile Picture (If linked)</button>
      </div>

      <!-- Settings -->
      <div id="settings" class="tab-content hidden fade-in">
        <h1 class="text-2xl font-bold mb-2">Settings</h1>
        <label class="flex items-center space-x-2">
          <input type="checkbox" id="themeToggle" onchange="toggleTheme()" />
          <span>Dark Theme</span>
        </label>
        <br />
       <button onclick="linkDiscord()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
  Link Discord
</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient('https://YOUR_PROJECT_ID.supabase.co', 'YOUR_PUBLIC_ANON_KEY');

    let user = null;

    const { data: { session } } = await supabase.auth.getSession();
    user = session?.user;

    if (!user) {
      window.location.href = '/';
    }

    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('id', user.id)
      .single();

    if (error) {
      alert('Profile fetch failed.');
      console.error(error);
    } else {
      document.getElementById('email').textContent = `Email: ${user.email}`;
      document.getElementById('username').textContent = `Username: ${data.username || 'No username'}`;
      document.getElementById('avatar').src = data.avatar_url || 'https://via.placeholder.com/100';
    }

    window.changeUsername = async () => {
      const newUsername = document.getElementById('new-username').value;
      const { error } = await supabase
        .from('users')
        .update({ username: newUsername })
        .eq('id', user.id);
      if (!error) {
        alert('Username updated!');
        location.reload();
      }
    };

    window.changeAvatar = async () => {
      const newUrl = document.getElementById('new-avatar').value;
      const { error } = await supabase
        .from('users')
        .update({ avatar_url: newUrl })
        .eq('id', user.id);
      if (!error) {
        alert('Avatar updated!');
        location.reload();
      }
    };

    window.useDiscordAvatar = async () => {
      const { data, error } = await supabase
        .from('users')
        .select('discord_avatar')
        .eq('id', user.id)
        .single();
      if (!error && data.discord_avatar) {
        await supabase
          .from('users')
          .update({ avatar_url: data.discord_avatar })
          .eq('id', user.id);
        alert('Discord avatar applied!');
        location.reload();
      } else {
        alert('No Discord avatar linked.');
      }
    };


    window.toggleTheme = () => {
      document.body.classList.toggle('dark');
    };

    // Initial state
    document.getElementById('themeToggle').checked = true;

    // Tab switching logic
    window.switchTab = (tabName) => {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
        tab.classList.remove('fade-in');
      });

      const activeTab = document.getElementById(tabName);
      if (activeTab) {
        activeTab.classList.remove('hidden');
        activeTab.classList.add('fade-in');
      }

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('bg-zinc-700');
        btn.classList.add('bg-zinc-800');
      });
      const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
      if (selectedButton) {
        selectedButton.classList.add('bg-zinc-700');
      }
    };

    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        switchTab(tab);
      });
    });

    async function linkDiscord() {
   const { data, error } = await supabase.auth.linkIdentity({
  provider: 'discord'
});

if (error) {
  console.error("Linking error:", error);
  alert("Failed to link Discord.");
} else {
  // Optionally refresh or notify user
  alert("Check the popup to finish linking Discord.");
}
  }

    switchTab('account'); // default tab
  </script>
</body>
</html>
