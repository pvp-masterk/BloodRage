<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customize - BloodRage</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body class="bg-black text-white font-sans">

<div class="flex min-h-screen">
  <!-- Sidebar -->
  <aside class="w-64 bg-zinc-900 p-6 space-y-4 border-r border-zinc-800">
    <h1 class="text-2xl font-bold text-red-500 mb-6">BloodRage</h1>
    <nav class="space-y-3">
      <a href="dashboard.html" class="block px-3 py-2 rounded hover:bg-red-600/20">Account</a>
      <a href="customize.html" class="block px-3 py-2 rounded bg-red-600/20">Customize</a>
      <a href="links.html" class="block px-3 py-2 rounded hover:bg-red-600/20">Links</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 space-y-8">
    <h2 class="text-3xl font-bold text-red-500 mb-6">Customize Your Profile</h2>

    <!-- Profile Preview -->
    <div id="profile-preview" class="rounded-xl p-8 text-center shadow-lg mb-8"
         style="background: linear-gradient(to right, #991b1b, #1e1b4b);">
      <div class="relative group w-24 h-24 mx-auto mb-4">
        <img id="avatar" src="" class="w-24 h-24 rounded-full border-4 border-white object-cover"/>
        <label for="avatarUpload" class="absolute inset-0 bg-black/50 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 cursor-pointer">
          <i class="fas fa-pencil-alt text-white"></i>
        </label>
        <input type="file" id="avatarUpload" class="hidden" accept="image/*"/>
      </div>
      <h3 id="username" class="text-2xl font-bold"></h3>
      <textarea id="bioInput" class="mt-2 p-2 w-full rounded bg-zinc-800 border border-zinc-700 text-white" rows="2" placeholder="Write your bio..."></textarea>
    </div>

    <!-- Toggles -->
    <div class="space-y-4">
      <label class="flex items-center space-x-3">
        <input type="checkbox" id="gradientToggle" class="w-5 h-5 text-red-600 rounded"/>
        <span>Enable Gradient</span>
      </label>
      <label class="flex items-center space-x-3">
        <input type="checkbox" id="discordAvatarToggle" class="w-5 h-5 text-red-600 rounded"/>
        <span>Use Discord Avatar</span>
      </label>
      <label class="flex items-center space-x-3">
        <input type="checkbox" id="enterButtonToggle" class="w-5 h-5 text-red-600 rounded"/>
        <span>Enter Button</span>
      </label>
    </div>

    <!-- Gradient Pickers -->
    <div id="gradientPickers" class="space-y-4 mt-6">
      <div>
        <label>Primary Color</label>
        <input type="color" id="primaryColor" class="ml-2"/>
      </div>
      <div>
        <label>Secondary Color</label>
        <input type="color" id="secondaryColor" class="ml-2"/>
      </div>
    </div>
  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://smcteblolwhfxcpngmvd.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtY3RlYmxvbHdoZnhjcG5nbXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0Nzk1MTUsImV4cCI6MjA3MDA1NTUxNX0.PWlZFiVv2E0Jah7tYGOGrbqkPwhxPoLhe0anINp0z3s");

function debounce(fn, delay) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
}

document.addEventListener('DOMContentLoaded', async () => {
  const user = (await supabase.auth.getUser()).data.user;
  if (!user) window.location.href = '/';

  let { data: profile } = await supabase.from("profiles").select("*").eq("id", user.id).single();
  if (!profile) return;

  // Populate UI
  document.getElementById("username").textContent = profile.username;
  document.getElementById("bioInput").value = profile.bio || "";
  document.getElementById("avatar").src = profile.avatar_url || "https://via.placeholder.com/100";
  document.getElementById("gradientToggle").checked = !!profile.gradient_enabled;
  document.getElementById("discordAvatarToggle").checked = !!profile.use_discord_avatar;
  document.getElementById("enterButtonToggle").checked = !!profile.show_enter_button;
  document.getElementById("primaryColor").value = profile.primary_color || "#991b1b";
  document.getElementById("secondaryColor").value = profile.secondary_color || "#1e1b4b";

  // Live bio update
  document.getElementById("bioInput").addEventListener("input", debounce(async (e) => {
    await supabase.from("profiles").update({ bio: e.target.value }).eq("id", user.id);
  }, 500));

  // Live avatar upload
  document.getElementById("avatarUpload").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const filePath = `avatars/${user.id}-${Date.now()}.${file.name.split('.').pop()}`;
    const { data: uploadData, error } = await supabase.storage.from("avatars").upload(filePath, file, { upsert: true });
    if (!error) {
      const { data: urlData } = supabase.storage.from("avatars").getPublicUrl(filePath);
      document.getElementById("avatar").src = urlData.publicUrl;
      await supabase.from("profiles").update({ avatar_url: urlData.publicUrl }).eq("id", user.id);
    }
  });

  // Toggles live update
  const toggleFields = {
    gradientToggle: "gradient_enabled",
    discordAvatarToggle: "use_discord_avatar",
    enterButtonToggle: "show_enter_button"
  };
  for (let [id, field] of Object.entries(toggleFields)) {
    document.getElementById(id).addEventListener("change", async (e) => {
      await supabase.from("profiles").update({ [field]: e.target.checked }).eq("id", user.id);
    });
  }

  // Gradient pickers live update
  const colorInputs = ["primaryColor", "secondaryColor"];
  for (let id of colorInputs) {
    document.getElementById(id).addEventListener("input", async () => {
      const primary = document.getElementById("primaryColor").value;
      const secondary = document.getElementById("secondaryColor").value;
      document.getElementById("profile-preview").style.background = `linear-gradient(to right, ${primary}, ${secondary})`;
      await supabase.from("profiles").update({
        primary_color: primary,
        secondary_color: secondary
      }).eq("id", user.id);
    });
  }
});
</script>
</body>
</html>
