<!DOCTYPE html>
<html>
<head>
  <title>guns.lol clone</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>guns.lol clone</h1>

  <button onclick="loginWithProvider('google')">Login with Google</button>
  <button onclick="loginWithProvider('discord')">Login with Discord</button>

  <div id="profile"></div>

  <script>
    const client = supabase.createClient("https://smcteblolwhfxcpngmvd.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtY3RlYmxvbHdoZnhjcG5nbXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0Nzk1MTUsImV4cCI6MjA3MDA1NTUxNX0.PWlZFiVv2E0Jah7tYGOGrbqkPwhxPoLhe0anINp0z3s");

    async function loginWithProvider(provider) {
      const { error } = await client.auth.signInWithOAuth({
        provider,
        options: {
          redirectTo: window.location.href
        }
      });
      if (error) alert('Login error: ' + error.message);
    }

    async function loadProfile() {
      const { data: { session } } = await client.auth.getSession();
      if (!session) return;

      const user = session.user;
      const { data, error } = await client
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .single();

      if (!data && !error) {
        await client.from("profiles").insert({
          id: user.id,
          username: user.user_metadata?.user_name || user.email.split('@')[0],
          avatar_url: user.user_metadata.avatar_url
        });
        return loadProfile();
      }

      document.getElementById('profile').innerHTML = `
        <p><strong>Username:</strong> ${data.username}</p>
        <img src="${data.avatar_url}" width="100">
        <p><a href="/${data.username}">Go to your profile</a></p>
      `;
    }

    loadProfile();
  </script>
</body>
</html>
